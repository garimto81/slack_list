name: Slack List Sync

on:
  pull_request:
    types: [closed]

env:
  SLACK_USER_TOKEN: ${{ secrets.SLACK_USER_TOKEN }}
  SLACK_LIST_ID: ${{ secrets.SLACK_LIST_ID }}

jobs:
  update-slack-list:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Extract Issue Number and Parse Checklist
        id: extract
        run: |
          # PR ì œëª© ë˜ëŠ” ë¸Œëœì¹˜ëª…ì—ì„œ #123 í˜•ì‹ì˜ Issue ë²ˆí˜¸ ì¶”ì¶œ
          PR_TITLE="${{ github.event.pull_request.title }}"
          BRANCH_NAME="${{ github.head_ref }}"

          # PR ì œëª©ì—ì„œ ë¨¼ì € ì‹œë„
          ISSUE_NUM=$(echo "$PR_TITLE" | grep -oE '#[0-9]+' | head -1 | tr -d '#')

          # ì—†ìœ¼ë©´ ë¸Œëœì¹˜ëª…ì—ì„œ ì‹œë„
          if [ -z "$ISSUE_NUM" ]; then
            ISSUE_NUM=$(echo "$BRANCH_NAME" | grep -oE '[0-9]+' | head -1)
          fi

          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT

          # PR ë³¸ë¬¸ì—ì„œ Checklist íŒŒì‹±
          PR_BODY=$(cat << 'EOFBODY'
          ${{ github.event.pull_request.body }}
          EOFBODY
          )

          # ì „ì²´ ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ìˆ˜ (- [ ] ë˜ëŠ” - [x])
          TOTAL=$(echo "$PR_BODY" | grep -cE '^\s*-\s*\[[ xX]\]' || echo 0)

          # ì™„ë£Œëœ í•­ëª© ìˆ˜ (- [x] ë˜ëŠ” - [X])
          DONE=$(echo "$PR_BODY" | grep -cE '^\s*-\s*\[[xX]\]' || echo 0)

          # ì§„í–‰ë¥  ê³„ì‚°
          if [ "$TOTAL" -gt 0 ]; then
            PROGRESS=$((DONE * 100 / TOTAL))
          else
            PROGRESS=100
          fi

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "done=$DONE" >> $GITHUB_OUTPUT
          echo "progress=$PROGRESS" >> $GITHUB_OUTPUT

          # ì§„í–‰ì¤‘ì¸ í•­ëª© ì¶”ì¶œ (ì²´í¬ ì•ˆëœ í•­ëª©, ìµœëŒ€ 5ê°œ)
          PENDING=$(echo "$PR_BODY" | grep -E '^\s*-\s*\[ \]' | sed 's/^\s*-\s*\[ \]\s*/â€¢ /' | head -5)
          PENDING_COUNT=$(echo "$PR_BODY" | grep -cE '^\s*-\s*\[ \]' || echo 0)

          # multiline ì¶œë ¥ì„ ìœ„í•œ ì²˜ë¦¬
          {
            echo 'pending<<EOF'
            echo "$PENDING"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

          echo "pending_count=$PENDING_COUNT" >> $GITHUB_OUTPUT

      - name: Get Slack List Item ID
        id: get_item
        if: steps.extract.outputs.issue_number != ''
        run: |
          RESPONSE=$(curl -s -X POST "https://slack.com/api/slackLists.items.list" \
            -H "Authorization: Bearer $SLACK_USER_TOKEN" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "list_id=$SLACK_LIST_ID")

          ISSUE_NUM="${{ steps.extract.outputs.issue_number }}"
          ITEM_ID=$(echo "$RESPONSE" | jq -r --arg num "#$ISSUE_NUM" \
            '.items[] | select(.fields[] | .text? == $num) | .id' | head -1)

          echo "item_id=$ITEM_ID" >> $GITHUB_OUTPUT

      - name: Create Slack List Item (if not exists)
        id: create_item
        if: steps.extract.outputs.issue_number != '' && steps.get_item.outputs.item_id == ''
        run: |
          ISSUE_NUM="${{ steps.extract.outputs.issue_number }}"
          PR_TITLE="${{ steps.extract.outputs.pr_title }}"

          # ìƒˆ í•­ëª© ìƒì„±
          RESPONSE=$(curl -s -X POST "https://slack.com/api/slackLists.items.create" \
            -H "Authorization: Bearer $SLACK_USER_TOKEN" \
            -H "Content-Type: application/json; charset=utf-8" \
            -d "{
              \"list_id\": \"$SLACK_LIST_ID\",
              \"item\": {
                \"fields\": {
                  \"title\": \"#$ISSUE_NUM - $PR_TITLE\"
                }
              }
            }")

          echo "API Response: $RESPONSE"

          # ìƒì„±ëœ í•­ëª© ID ì¶”ì¶œ
          NEW_ITEM_ID=$(echo "$RESPONSE" | jq -r '.item.id // empty')
          echo "item_id=$NEW_ITEM_ID" >> $GITHUB_OUTPUT
          echo "Created new item: $NEW_ITEM_ID"

      - name: Build Progress Bar
        id: progress_bar
        run: |
          PROGRESS="${{ steps.extract.outputs.progress }}"
          TOTAL="${{ steps.extract.outputs.total }}"
          DONE="${{ steps.extract.outputs.done }}"
          PENDING_COUNT="${{ steps.extract.outputs.pending_count }}"

          # 10ì¹¸ í”„ë¡œê·¸ë ˆìŠ¤ ë°” ìƒì„±
          FILLED=$((PROGRESS / 10))
          EMPTY=$((10 - FILLED))

          BAR=""
          for i in $(seq 1 $FILLED); do BAR+="â–ˆ"; done
          for i in $(seq 1 $EMPTY); do BAR+="â–‘"; done

          # ì§„í–‰ë¥  í•„ë“œìš© í…ìŠ¤íŠ¸ (í”„ë¡œê·¸ë ˆìŠ¤ ë°”)
          if [ "$TOTAL" -gt 0 ]; then
            PROGRESS_BAR="$BAR $PROGRESS% ($DONE/$TOTAL)"
          else
            PROGRESS_BAR="$BAR 100%"
          fi

          # ë¹„ê³  í•„ë“œìš© í…ìŠ¤íŠ¸ (ì§„í–‰ì¤‘ì¸ í•­ëª©ë§Œ)
          if [ "$TOTAL" -gt 0 ]; then
            if [ "$PENDING_COUNT" -eq 0 ]; then
              NOTE_TEXT="âœ… ëª¨ë‘ ì™„ë£Œ!"
            else
              PENDING_ITEMS=$(cat << 'EOFPENDING'
          ${{ steps.extract.outputs.pending }}
          EOFPENDING
          )
              if [ "$PENDING_COUNT" -gt 5 ]; then
                EXTRA=$((PENDING_COUNT - 5))
                NOTE_TEXT="ğŸ”„ ì§„í–‰ì¤‘:\n$PENDING_ITEMS\nâ€¢ ì™¸ ${EXTRA}ê°œ"
              else
                NOTE_TEXT="ğŸ”„ ì§„í–‰ì¤‘:\n$PENDING_ITEMS"
              fi
            fi
          else
            PR_TITLE="${{ steps.extract.outputs.pr_title }}"
            NOTE_TEXT="ğŸ“ $PR_TITLE"
          fi

          echo "progress_bar=$PROGRESS_BAR" >> $GITHUB_OUTPUT
          {
            echo 'note<<EOF'
            echo "$NOTE_TEXT"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Update Slack List Item
        if: steps.get_item.outputs.item_id != '' || steps.create_item.outputs.item_id != ''
        run: |
          # ê¸°ì¡´ í•­ëª© ë˜ëŠ” ìƒˆë¡œ ìƒì„±ëœ í•­ëª© ID ì‚¬ìš©
          ITEM_ID="${{ steps.get_item.outputs.item_id }}"
          if [ -z "$ITEM_ID" ]; then
            ITEM_ID="${{ steps.create_item.outputs.item_id }}"
          fi

          # ì§„í–‰ë¥  í•„ë“œìš© í”„ë¡œê·¸ë ˆìŠ¤ ë°”
          PROGRESS_BAR="${{ steps.progress_bar.outputs.progress_bar }}"

          # ë¹„ê³  í•„ë“œ ë‚´ìš© êµ¬ì„±
          NOTE_TEXT=$(cat << 'EOFNOTE'
          ${{ steps.progress_bar.outputs.note }}
          EOFNOTE
          )

          # JSON ì´ìŠ¤ì¼€ì´í”„ (ì¤„ë°”ê¿ˆ, ë”°ì˜´í‘œ)
          NOTE_JSON=$(echo "$NOTE_TEXT" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

          # ì§„í–‰ë¥ (í”„ë¡œê·¸ë ˆìŠ¤ ë°”) + ë¹„ê³ (ì§„í–‰ì¤‘ í•­ëª©) ì—…ë°ì´íŠ¸
          curl -s -X POST "https://slack.com/api/slackLists.items.update" \
            -H "Authorization: Bearer $SLACK_USER_TOKEN" \
            -H "Content-Type: application/json; charset=utf-8" \
            -d "{
              \"list_id\": \"$SLACK_LIST_ID\",
              \"cells\": [
                {
                  \"row_id\": \"$ITEM_ID\",
                  \"column_id\": \"Col0A55RYJHEV\",
                  \"rich_text\": [{
                    \"type\": \"rich_text\",
                    \"elements\": [{
                      \"type\": \"rich_text_section\",
                      \"elements\": [{
                        \"type\": \"text\",
                        \"text\": \"$PROGRESS_BAR\"
                      }]
                    }]
                  }]
                },
                {
                  \"row_id\": \"$ITEM_ID\",
                  \"column_id\": \"Col0A4WG5SFD2\",
                  \"rich_text\": [{
                    \"type\": \"rich_text\",
                    \"elements\": [{
                      \"type\": \"rich_text_section\",
                      \"elements\": [{
                        \"type\": \"text\",
                        \"text\": \"$NOTE_JSON\"
                      }]
                    }]
                  }]
                }
              ]
            }"
