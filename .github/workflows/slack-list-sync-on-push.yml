name: Slack List Sync (Checklist Change)

on:
  push:
    branches: [main]
    paths:
      - 'docs/checklists/*.md'
      - 'tasks/prds/*-prd-*.md'
      - 'docs/PRD-*.md'
      - 'docs/CHECKLIST.md'

concurrency:
  group: slack-list-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  SLACK_USER_TOKEN: ${{ secrets.SLACK_USER_TOKEN }}
  SLACK_LIST_ID: ${{ secrets.SLACK_LIST_ID }}

jobs:
  update-slack-list:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # Step 1: Î≥ÄÍ≤ΩÎêú Checklist ÌååÏùº Í∞êÏßÄ
      - name: Detect Changed Checklists
        id: changed_files
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E '^(docs/checklists/|tasks/prds/|docs/PRD-|docs/CHECKLIST).*\.md$' || true)

          if [ -z "$CHANGED" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No checklist changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            {
              echo 'files<<EOF'
              echo "$CHANGED"
              echo 'EOF'
            } >> $GITHUB_OUTPUT
            echo "Changed files:"
            echo "$CHANGED"
          fi

      # Step 2: Í∞Å Î≥ÄÍ≤ΩÎêú Checklist Ï≤òÎ¶¨
      - name: Process Changed Checklists
        if: steps.changed_files.outputs.has_changes == 'true'
        id: process_checklists
        run: |
          FULL_REPO="${{ github.repository }}"
          DEFAULT_REPO_NAME=$(echo "$FULL_REPO" | cut -d'/' -f2)

          # Í≤∞Í≥º Ï†ÄÏû•Ïö©
          RESULTS=""

          echo "${{ steps.changed_files.outputs.files }}" | while read -r FILE; do
            if [ -z "$FILE" ]; then continue; fi

            echo "Processing: $FILE"

            # PRD ID Ï∂îÏ∂ú
            PRD_ID=$(basename "$FILE" .md | grep -oE 'PRD-[0-9]+' || echo "")
            echo "  PRD ID: $PRD_ID"

            # Repository Ï∂îÏ∂ú (Î¨∏ÏÑú ÎÇ¥ **Repository**: Í∞í)
            REPO_NAME=$(grep -oP '\*\*Repository\*\*:\s*\K\S+' "$FILE" 2>/dev/null || echo "")
            if [ -z "$REPO_NAME" ]; then
              REPO_NAME="$DEFAULT_REPO_NAME"
            fi
            echo "  Repository: $REPO_NAME"

            # Checklist ÌååÏã±
            TOTAL=$(grep -cE '^\s*[-|]\s*\[[ xX]\]' "$FILE" 2>/dev/null || echo 0)
            DONE=$(grep -cE '^\s*[-|]\s*\[[xX]\]' "$FILE" 2>/dev/null || echo 0)

            if [ "$TOTAL" -gt 0 ]; then
              PROGRESS=$((DONE * 100 / TOTAL))
            else
              PROGRESS=100
            fi
            echo "  Progress: $DONE/$TOTAL ($PROGRESS%)"

            # ÏßÑÌñâÏ§ë Ìï≠Î™© Ï∂îÏ∂ú
            PENDING=$(grep -E '^\s*[-|]\s*\[ \]' "$FILE" 2>/dev/null | sed 's/^\s*[-|]\s*\[ \]\s*/‚Ä¢ /' | head -5)
            PENDING_COUNT=$(grep -cE '^\s*[-|]\s*\[ \]' "$FILE" 2>/dev/null || echo 0)

            # Í≤∞Í≥º ÎàÑÏ†Å (ÌååÏù¥ÌîÑ ÌòïÏãù)
            echo "$FILE|$REPO_NAME|$PROGRESS|$DONE|$TOTAL|$PENDING_COUNT" >> /tmp/checklist_results.txt
          done

          if [ -f /tmp/checklist_results.txt ]; then
            {
              echo 'results<<EOF'
              cat /tmp/checklist_results.txt
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          fi

      # Step 3: Slack List ÏóÖÎç∞Ïù¥Ìä∏
      - name: Update Slack List
        if: steps.changed_files.outputs.has_changes == 'true'
        run: |
          # ÌòÑÏû¨ ÎÇ†Ïßú (KST)
          CURRENT_DATE=$(TZ=Asia/Seoul date +"%Y-%m-%d")

          echo "${{ steps.changed_files.outputs.files }}" | while read -r FILE; do
            if [ -z "$FILE" ]; then continue; fi

            echo "Updating Slack for: $FILE"

            # Repository Ï∂îÏ∂ú
            FULL_REPO="${{ github.repository }}"
            DEFAULT_REPO_NAME=$(echo "$FULL_REPO" | cut -d'/' -f2)
            REPO_NAME=$(grep -oP '\*\*Repository\*\*:\s*\K\S+' "$FILE" 2>/dev/null || echo "$DEFAULT_REPO_NAME")

            # Checklist ÌååÏã±
            TOTAL=$(grep -cE '^\s*[-|]\s*\[[ xX]\]' "$FILE" 2>/dev/null || echo 0)
            DONE=$(grep -cE '^\s*[-|]\s*\[[xX]\]' "$FILE" 2>/dev/null || echo 0)
            PENDING_COUNT=$(grep -cE '^\s*[-|]\s*\[ \]' "$FILE" 2>/dev/null || echo 0)

            if [ "$TOTAL" -gt 0 ]; then
              PROGRESS=$((DONE * 100 / TOTAL))
            else
              PROGRESS=100
            fi

            # ÌîÑÎ°úÍ∑∏Î†àÏä§ Î∞î ÏÉùÏÑ± (Ïª¨Îü¨ Ïù¥Î™®ÏßÄ Î≤ÑÏ†Ñ)
            if [ "$TOTAL" -gt 0 ]; then
              # Îã®Í≥ÑÎ≥Ñ Ïù¥Î™®ÏßÄ Í≤∞Ï†ï
              if [ "$PROGRESS" -le 30 ]; then
                STATUS_EMOJI="üî¥"
                FILL_BLOCK="üü•"
              elif [ "$PROGRESS" -le 70 ]; then
                STATUS_EMOJI="üü°"
                FILL_BLOCK="üü®"
              else
                STATUS_EMOJI="üü¢"
                FILL_BLOCK="üü©"
              fi

              EMPTY_BLOCK="‚¨ú"
              FILLED=$((PROGRESS / 10))
              EMPTY=$((10 - FILLED))

              BAR=""
              for i in $(seq 1 $FILLED); do BAR+="$FILL_BLOCK"; done
              for i in $(seq 1 $EMPTY); do BAR+="$EMPTY_BLOCK"; done

              PROGRESS_BAR="$STATUS_EMOJI $BAR $PROGRESS% ($DONE/$TOTAL)"

              # ÎπÑÍ≥† ÌïÑÎìú
              if [ "$PENDING_COUNT" -eq 0 ]; then
                NOTE_TEXT="‚úÖ Î™®Îëê ÏôÑÎ£å!"
              else
                PENDING_ITEMS=$(grep -E '^\s*[-|]\s*\[ \]' "$FILE" 2>/dev/null | sed 's/^\s*[-|]\s*\[ \]\s*/‚Ä¢ /' | head -5)
                if [ "$PENDING_COUNT" -gt 5 ]; then
                  EXTRA=$((PENDING_COUNT - 5))
                  NOTE_TEXT="üîÑ ÏßÑÌñâÏ§ë:\n$PENDING_ITEMS\n‚Ä¢ Ïô∏ ${EXTRA}Í∞ú"
                else
                  NOTE_TEXT="üîÑ ÏßÑÌñâÏ§ë:\n$PENDING_ITEMS"
                fi
              fi
            else
              PROGRESS_BAR="N/A"
              NOTE_TEXT="üìù Checklist ÏóÜÏùå"
            fi

            # Slack ListÏóêÏÑú Ìï≠Î™© Í≤ÄÏÉâ
            RESPONSE=$(curl -s -X POST "https://slack.com/api/slackLists.items.list" \
              -H "Authorization: Bearer $SLACK_USER_TOKEN" \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -d "list_id=$SLACK_LIST_ID")

            ITEM_ID=$(echo "$RESPONSE" | jq -r --arg repo "$REPO_NAME" \
              '.items[] | select(
                .fields[] | select(.column_id == "Col0A4WG2LPHA") | .text == $repo
              ) | .id' | head -1)

            # Ìï≠Î™©Ïù¥ ÏóÜÏúºÎ©¥ ÏÉùÏÑ±
            if [ -z "$ITEM_ID" ]; then
              echo "  Creating new item for: $REPO_NAME"
              CREATE_RESPONSE=$(curl -s -X POST "https://slack.com/api/slackLists.items.create" \
                -H "Authorization: Bearer $SLACK_USER_TOKEN" \
                -H "Content-Type: application/json; charset=utf-8" \
                -d "{
                  \"list_id\": \"$SLACK_LIST_ID\",
                  \"item\": { \"fields\": {} }
                }")

              ITEM_ID=$(echo "$CREATE_RESPONSE" | jq -r '.item.id // empty')

              # Ï†úÎ™© ÏÑ§Ï†ï
              if [ -n "$ITEM_ID" ]; then
                curl -s -X POST "https://slack.com/api/slackLists.items.update" \
                  -H "Authorization: Bearer $SLACK_USER_TOKEN" \
                  -H "Content-Type: application/json; charset=utf-8" \
                  -d "{
                    \"list_id\": \"$SLACK_LIST_ID\",
                    \"cells\": [{
                      \"row_id\": \"$ITEM_ID\",
                      \"column_id\": \"Col0A4WG2LPHA\",
                      \"rich_text\": [{
                        \"type\": \"rich_text\",
                        \"elements\": [{
                          \"type\": \"rich_text_section\",
                          \"elements\": [{
                            \"type\": \"text\",
                            \"text\": \"$REPO_NAME\"
                          }]
                        }]
                      }]
                    }]
                  }"
              fi
            fi

            if [ -z "$ITEM_ID" ]; then
              echo "  Error: Could not find or create item for $REPO_NAME"
              continue
            fi

            echo "  Updating item: $ITEM_ID"

            # JSON Ïù¥Ïä§ÏºÄÏù¥ÌîÑ
            NOTE_JSON=$(echo "$NOTE_TEXT" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

            # Slack List ÏóÖÎç∞Ïù¥Ìä∏
            curl -s -X POST "https://slack.com/api/slackLists.items.update" \
              -H "Authorization: Bearer $SLACK_USER_TOKEN" \
              -H "Content-Type: application/json; charset=utf-8" \
              -d "{
                \"list_id\": \"$SLACK_LIST_ID\",
                \"cells\": [
                  {
                    \"row_id\": \"$ITEM_ID\",
                    \"column_id\": \"Col0A55RYJHEV\",
                    \"rich_text\": [{
                      \"type\": \"rich_text\",
                      \"elements\": [{
                        \"type\": \"rich_text_section\",
                        \"elements\": [{
                          \"type\": \"text\",
                          \"text\": \"$PROGRESS_BAR\"
                        }]
                      }]
                    }]
                  },
                  {
                    \"row_id\": \"$ITEM_ID\",
                    \"column_id\": \"Col0A4WG5SFD2\",
                    \"rich_text\": [{
                      \"type\": \"rich_text\",
                      \"elements\": [{
                        \"type\": \"rich_text_section\",
                        \"elements\": [{
                          \"type\": \"text\",
                          \"text\": \"$NOTE_JSON\"
                        }]
                      }]
                    }]
                  },
                  {
                    \"row_id\": \"$ITEM_ID\",
                    \"column_id\": \"Col0A4ZL4THPU\",
                    \"date\": [\"$CURRENT_DATE\"]
                  }
                ]
              }"

            echo "  Updated: $REPO_NAME ($PROGRESS_BAR)"
          done

          echo "All updates completed"
